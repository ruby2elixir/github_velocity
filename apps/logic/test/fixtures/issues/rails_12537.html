



<!DOCTYPE html>
<html lang="en" class="">
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Language" content="en">
    <meta name="viewport" content="width=1020">


    <title>Major performance regression when preloading has_many_through association · Issue #12537 · rails/rails · GitHub</title>
    <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="GitHub">
    <link rel="fluid-icon" href="https://github.com/fluidicon.png" title="GitHub">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-114.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-144.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144.png">
    <meta property="fb:app_id" content="1401488693436528">

      <meta content="@github" name="twitter:site" /><meta content="summary" name="twitter:card" /><meta content="Major performance regression when preloading has_many_through association · Issue #12537 · rails/rails" name="twitter:title" /><meta content="Between Rails 3.2 and 4.1.0 beta, the performance of preloading a has_many_through association has declined. A commit, #12090, brought performance back to the range of one third the speed of Rails ..." name="twitter:description" /><meta content="https://avatars1.githubusercontent.com/u/87623?v=3&amp;s=400" name="twitter:image:src" />
      <meta content="GitHub" property="og:site_name" /><meta content="object" property="og:type" /><meta content="https://avatars1.githubusercontent.com/u/87623?v=3&amp;s=400" property="og:image" /><meta content="Major performance regression when preloading has_many_through association · Issue #12537 · rails/rails" property="og:title" /><meta content="https://github.com/rails/rails/issues/12537" property="og:url" /><meta content="Between Rails 3.2 and 4.1.0 beta, the performance of preloading a has_many_through association has declined. A commit, #12090, brought performance back to the range of one third the speed of Rails ..." property="og:description" />
      <meta name="browser-stats-url" content="https://api.github.com/_private/browser/stats">
    <meta name="browser-errors-url" content="https://api.github.com/_private/browser/errors">
    <link rel="assets" href="https://assets-cdn.github.com/">

    <meta name="pjax-timeout" content="1000">


    <meta name="msapplication-TileImage" content="/windows-tile.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="selected-link" value="repo_issues" data-pjax-transient>

    <meta name="google-site-verification" content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU">
    <meta name="google-analytics" content="UA-3769691-2">

<meta content="collector.githubapp.com" name="octolytics-host" /><meta content="github" name="octolytics-app-id" /><meta content="25783735:6924:240BF8A9:56797584" name="octolytics-dimension-request_id" />
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/issues/show" data-pjax-transient="true" name="analytics-location" />
<meta content="Rails, view, issues#show" data-pjax-transient="true" name="analytics-event" />


  <meta class="js-ga-set" name="dimension1" content="Logged Out">



        <meta name="hostname" content="github.com">
    <meta name="user-login" content="">

        <meta name="expected-hostname" content="github.com">

      <link rel="mask-icon" href="https://assets-cdn.github.com/pinned-octocat.svg" color="#4078c0">
      <link rel="icon" type="image/x-icon" href="https://assets-cdn.github.com/favicon.ico">

    <meta content="9a3dc4e7f2b4d6410c95623b7687fcb6ae8f092f" name="form-nonce" />

    <link crossorigin="anonymous" href="https://assets-cdn.github.com/assets/github-2037283749006a7ebc37dc5a63a365e8cde9e5d0099e83d4a77bba85b03a6623.css" media="all" rel="stylesheet" />
    <link crossorigin="anonymous" href="https://assets-cdn.github.com/assets/github2-87b394aa7bb776e9e05abfb54eaa1193404e767a3720d64ff2c8f64c7cfb432b.css" media="all" rel="stylesheet" />




    <meta http-equiv="x-pjax-version" content="696c3d92b2b36833513e39f2a164890b">


  <meta name="description" content="rails - Ruby on Rails">
  <meta name="go-import" content="github.com/rails/rails git https://github.com/rails/rails.git">

  <meta content="4223" name="octolytics-dimension-user_id" /><meta content="rails" name="octolytics-dimension-user_login" /><meta content="8514" name="octolytics-dimension-repository_id" /><meta content="rails/rails" name="octolytics-dimension-repository_nwo" /><meta content="true" name="octolytics-dimension-repository_public" /><meta content="false" name="octolytics-dimension-repository_is_fork" /><meta content="8514" name="octolytics-dimension-repository_network_root_id" /><meta content="rails/rails" name="octolytics-dimension-repository_network_root_nwo" />
  <link href="https://github.com/rails/rails/commits/master.atom" rel="alternate" title="Recent Commits to rails:master" type="application/atom+xml">

  </head>


  <body class="logged_out   env-production  vis-public">
    <a href="#start-of-content" tabindex="1" class="accessibility-aid js-skip-to-content">Skip to content</a>








      <div class="header header-logged-out" role="banner">
  <div class="container clearfix">

    <a class="header-logo-wordmark" href="https://github.com/" data-ga-click="(Logged out) Header, go to homepage, icon:logo-wordmark">
      <span class="mega-octicon octicon-logo-github"></span>
    </a>

    <div class="header-actions" role="navigation">
        <a class="btn btn-primary" href="/join" data-ga-click="(Logged out) Header, clicked Sign up, text:sign-up">Sign up</a>
      <a class="btn" href="/login?return_to=%2Frails%2Frails%2Fissues%2F12537" data-ga-click="(Logged out) Header, clicked Sign in, text:sign-in">Sign in</a>
    </div>

    <div class="site-search repo-scope js-site-search" role="search">
      <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/rails/rails/search" class="js-site-search-form" data-global-search-url="/search" data-repo-search-url="/rails/rails/search" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /></div>
  <label class="js-chromeless-input-container form-control">
    <div class="scope-badge">This repository</div>
    <input type="text"
      class="js-site-search-focus js-site-search-field is-clearable chromeless-input"
      data-hotkey="s"
      name="q"
      placeholder="Search"
      aria-label="Search this repository"
      data-global-scope-placeholder="Search GitHub"
      data-repo-scope-placeholder="Search"
      tabindex="1"
      autocapitalize="off">
  </label>
</form>
    </div>

      <ul class="header-nav left" role="navigation">
          <li class="header-nav-item">
            <a class="header-nav-link" href="/explore" data-ga-click="(Logged out) Header, go to explore, text:explore">Explore</a>
          </li>
          <li class="header-nav-item">
            <a class="header-nav-link" href="/features" data-ga-click="(Logged out) Header, go to features, text:features">Features</a>
          </li>
          <li class="header-nav-item">
            <a class="header-nav-link" href="https://enterprise.github.com/" data-ga-click="(Logged out) Header, go to enterprise, text:enterprise">Enterprise</a>
          </li>
          <li class="header-nav-item">
            <a class="header-nav-link" href="/pricing" data-ga-click="(Logged out) Header, go to pricing, text:pricing">Pricing</a>
          </li>
      </ul>

  </div>
</div>



    <div id="start-of-content" class="accessibility-aid"></div>

      <div id="js-flash-container">
</div>


    <div role="main" class="main-content">
        <div itemscope itemtype="http://schema.org/WebPage">
    <div id="js-repo-pjax-container" class="context-loader-container js-repo-nav-next" data-pjax-container>

<div class="pagehead repohead instapaper_ignore readability-menu experiment-repo-nav">
  <div class="container repohead-details-container">



<ul class="pagehead-actions">

  <li>
      <a href="/login?return_to=%2Frails%2Frails"
    class="btn btn-sm btn-with-count tooltipped tooltipped-n"
    aria-label="You must be signed in to watch a repository" rel="nofollow">
    <span class="octicon octicon-eye"></span>
    Watch
  </a>
  <a class="social-count" href="/rails/rails/watchers">
    2,087
  </a>

  </li>

  <li>
      <a href="/login?return_to=%2Frails%2Frails"
    class="btn btn-sm btn-with-count tooltipped tooltipped-n"
    aria-label="You must be signed in to star a repository" rel="nofollow">
    <span class="octicon octicon-star "></span>
    Star
  </a>

    <a class="social-count js-social-count" href="/rails/rails/stargazers">
      28,850
    </a>

  </li>

  <li>
      <a href="/login?return_to=%2Frails%2Frails"
        class="btn btn-sm btn-with-count tooltipped tooltipped-n"
        aria-label="You must be signed in to fork a repository" rel="nofollow">
        <span class="octicon octicon-repo-forked "></span>
        Fork
      </a>

    <a href="/rails/rails/network" class="social-count">
      11,689
    </a>
  </li>
</ul>

    <h1 itemscope itemtype="http://data-vocabulary.org/Breadcrumb" class="entry-title public ">
  <span class="octicon octicon-repo "></span>
  <span class="author"><a href="/rails" class="url fn" itemprop="url" rel="author"><span itemprop="title">rails</span></a></span><!--
--><span class="path-divider">/</span><!--
--><strong><a href="/rails/rails" data-pjax="#js-repo-pjax-container">rails</a></strong>

  <span class="page-context-loader">
    <img alt="" height="16" src="https://assets-cdn.github.com/images/spinners/octocat-spinner-32.gif" width="16" />
  </span>

</h1>

  </div>
  <div class="container">

<nav class="reponav js-repo-nav js-sidenav-container-pjax js-octicon-loaders"
     role="navigation"
     data-pjax="#js-repo-pjax-container">

  <a href="/rails/rails" aria-label="Code" class="js-selected-navigation-item reponav-item" data-hotkey="g c" data-selected-links="repo_source repo_downloads repo_commits repo_releases repo_tags repo_branches /rails/rails">
    <span class="octicon octicon-code "></span>
    Code
</a>
    <a href="/rails/rails/issues" aria-selected="true" class="js-selected-navigation-item selected reponav-item" data-hotkey="g i" data-selected-links="repo_issues repo_labels repo_milestones /rails/rails/issues">
      <span class="octicon octicon-issue-opened "></span>
      Issues
      <span class="counter">415</span>
</a>
  <a href="/rails/rails/pulls" class="js-selected-navigation-item reponav-item" data-hotkey="g p" data-selected-links="repo_pulls /rails/rails/pulls">
    <span class="octicon octicon-git-pull-request "></span>
    Pull requests
    <span class="counter">454</span>
</a>

  <a href="/rails/rails/pulse" class="js-selected-navigation-item reponav-item" data-selected-links="pulse /rails/rails/pulse">
    <span class="octicon octicon-pulse "></span>
    Pulse
</a>
  <a href="/rails/rails/graphs" class="js-selected-navigation-item reponav-item" data-selected-links="repo_graphs repo_contributors /rails/rails/graphs">
    <span class="octicon octicon-graph "></span>
    Graphs
</a>

</nav>

  </div>
</div>

<div class="container new-discussion-timeline experiment-repo-nav">
  <div class="repository-content">


<style type="text/css" media="screen">
  span.labelstyle-bfdadc, .linked-labelstyle-bfdadc {  background-color: #bfdadc !important;  color: #2c3233 !important;}.labelstyle-bfdadc.selected {  background-color: #bfdadc !important;  color: #2c3233 !important;}.label-select-menu .labelstyle-bfdadc.selected {  background:rgba(191, 218, 220, 0.12) !important;  color: #849799 !important;}

span.labelstyle-8B00FC, .linked-labelstyle-8B00FC {  background-color: #8B00FC !important;  color: #fff !important;}.labelstyle-8B00FC.selected {  background-color: #8B00FC !important;  color: #fff !important;}.label-select-menu .labelstyle-8B00FC.selected {  background:rgba(139, 0, 252, 0.12) !important;  color: #540099 !important;}

span.labelstyle-FFF700, .linked-labelstyle-FFF700 {  background-color: #FFF700 !important;  color: #333100 !important;}.labelstyle-FFF700.selected {  background-color: #FFF700 !important;  color: #333100 !important;}.label-select-menu .labelstyle-FFF700.selected {  background:rgba(255, 247, 0, 0.12) !important;  color: #999400 !important;}

span.labelstyle-d7e102, .linked-labelstyle-d7e102 {  background-color: #d7e102 !important;  color: #303300 !important;}.labelstyle-d7e102.selected {  background-color: #d7e102 !important;  color: #303300 !important;}.label-select-menu .labelstyle-d7e102.selected {  background:rgba(215, 225, 2, 0.12) !important;  color: #929901 !important;}

span.labelstyle-5319e7, .linked-labelstyle-5319e7 {  background-color: #5319e7 !important;  color: #fff !important;}.labelstyle-5319e7.selected {  background-color: #5319e7 !important;  color: #fff !important;}.label-select-menu .labelstyle-5319e7.selected {  background:rgba(83, 25, 231, 0.12) !important;  color: #361099 !important;}

span.labelstyle-00E5FF, .linked-labelstyle-00E5FF {  background-color: #00E5FF !important;  color: #002d33 !important;}.labelstyle-00E5FF.selected {  background-color: #00E5FF !important;  color: #002d33 !important;}.label-select-menu .labelstyle-00E5FF.selected {  background:rgba(0, 229, 255, 0.12) !important;  color: #008999 !important;}

span.labelstyle-0b02e1, .linked-labelstyle-0b02e1 {  background-color: #0b02e1 !important;  color: #fff !important;}.labelstyle-0b02e1.selected {  background-color: #0b02e1 !important;  color: #fff !important;}.label-select-menu .labelstyle-0b02e1.selected {  background:rgba(11, 2, 225, 0.30720418300653585) !important;  color: #040066 !important;}

span.labelstyle-FC9300, .linked-labelstyle-FC9300 {  background-color: #FC9300 !important;  color: #331d00 !important;}.labelstyle-FC9300.selected {  background-color: #FC9300 !important;  color: #331d00 !important;}.label-select-menu .labelstyle-FC9300.selected {  background:rgba(252, 147, 0, 0.12) !important;  color: #995900 !important;}

span.labelstyle-ededed, .linked-labelstyle-ededed {  background-color: #ededed !important;  color: #333333 !important;}.labelstyle-ededed.selected {  background-color: #ededed !important;  color: #333333 !important;}.label-select-menu .labelstyle-ededed.selected {  background:rgba(237, 237, 237, 0.12) !important;  color: #999999 !important;}

span.labelstyle-006b75, .linked-labelstyle-006b75 {  background-color: #006b75 !important;  color: #fff !important;}.labelstyle-006b75.selected {  background-color: #006b75 !important;  color: #fff !important;}.label-select-menu .labelstyle-006b75.selected {  background:rgba(0, 107, 117, 0.12) !important;  color: #008b99 !important;}

span.labelstyle-02d7e1, .linked-labelstyle-02d7e1 {  background-color: #02d7e1 !important;  color: #003033 !important;}.labelstyle-02d7e1.selected {  background-color: #02d7e1 !important;  color: #003033 !important;}.label-select-menu .labelstyle-02d7e1.selected {  background:rgba(2, 215, 225, 0.12) !important;  color: #019299 !important;}

span.labelstyle-e102d8, .linked-labelstyle-e102d8 {  background-color: #e102d8 !important;  color: #fff !important;}.labelstyle-e102d8.selected {  background-color: #e102d8 !important;  color: #fff !important;}.label-select-menu .labelstyle-e102d8.selected {  background:rgba(225, 2, 216, 0.12) !important;  color: #990192 !important;}

span.labelstyle-d4c5f9, .linked-labelstyle-d4c5f9 {  background-color: #d4c5f9 !important;  color: #2b2833 !important;}.labelstyle-d4c5f9.selected {  background-color: #d4c5f9 !important;  color: #2b2833 !important;}.label-select-menu .labelstyle-d4c5f9.selected {  background:rgba(212, 197, 249, 0.12) !important;  color: #827999 !important;}

span.labelstyle-eb6420, .linked-labelstyle-eb6420 {  background-color: #eb6420 !important;  color: #fff !important;}.labelstyle-eb6420.selected {  background-color: #eb6420 !important;  color: #fff !important;}.label-select-menu .labelstyle-eb6420.selected {  background:rgba(235, 100, 32, 0.12) !important;  color: #994114 !important;}

span.labelstyle-e10c02, .linked-labelstyle-e10c02 {  background-color: #e10c02 !important;  color: #fff !important;}.labelstyle-e10c02.selected {  background-color: #e10c02 !important;  color: #fff !important;}.label-select-menu .labelstyle-e10c02.selected {  background:rgba(225, 12, 2, 0.12) !important;  color: #990801 !important;}

span.labelstyle-000000, .linked-labelstyle-000000 {  background-color: #000000 !important;  color: #fff !important;}.labelstyle-000000.selected {  background-color: #000000 !important;  color: #fff !important;}.label-select-menu .labelstyle-000000.selected {  background:rgba(247, 247, 247, 1.0) !important;  color: #666666 !important;}

span.labelstyle-f7c6c7, .linked-labelstyle-f7c6c7 {  background-color: #f7c6c7 !important;  color: #332829 !important;}.labelstyle-f7c6c7.selected {  background-color: #f7c6c7 !important;  color: #332829 !important;}.label-select-menu .labelstyle-f7c6c7.selected {  background:rgba(247, 198, 199, 0.12) !important;  color: #997a7b !important;}

span.labelstyle-fbca04, .linked-labelstyle-fbca04 {  background-color: #fbca04 !important;  color: #332900 !important;}.labelstyle-fbca04.selected {  background-color: #fbca04 !important;  color: #332900 !important;}.label-select-menu .labelstyle-fbca04.selected {  background:rgba(251, 202, 4, 0.12) !important;  color: #997b02 !important;}

span.labelstyle-8BE06E, .linked-labelstyle-8BE06E {  background-color: #8BE06E !important;  color: #1f3219 !important;}.labelstyle-8BE06E.selected {  background-color: #8BE06E !important;  color: #1f3219 !important;}.label-select-menu .labelstyle-8BE06E.selected {  background:rgba(139, 224, 110, 0.12) !important;  color: #5e994b !important;}

span.labelstyle-e11d21, .linked-labelstyle-e11d21 {  background-color: #e11d21 !important;  color: #fff !important;}.labelstyle-e11d21.selected {  background-color: #e11d21 !important;  color: #fff !important;}.label-select-menu .labelstyle-e11d21.selected {  background:rgba(225, 29, 33, 0.12) !important;  color: #991316 !important;}

span.labelstyle-D94A4A, .linked-labelstyle-D94A4A {  background-color: #D94A4A !important;  color: #fff !important;}.labelstyle-D94A4A.selected {  background-color: #D94A4A !important;  color: #fff !important;}.label-select-menu .labelstyle-D94A4A.selected {  background:rgba(217, 74, 74, 0.12) !important;  color: #993434 !important;}

span.labelstyle-444444, .linked-labelstyle-444444 {  background-color: #444444 !important;  color: #fff !important;}.labelstyle-444444.selected {  background-color: #444444 !important;  color: #fff !important;}.label-select-menu .labelstyle-444444.selected {  background:rgba(68, 68, 68, 0.12) !important;  color: #999999 !important;}

span.labelstyle-009800, .linked-labelstyle-009800 {  background-color: #009800 !important;  color: #fff !important;}.labelstyle-009800.selected {  background-color: #009800 !important;  color: #fff !important;}.label-select-menu .labelstyle-009800.selected {  background:rgba(0, 152, 0, 0.12) !important;  color: #009900 !important;}
</style>

<div class="issues-listing" data-pjax>
  <div class="context-loader large-format-loader">
  <p><img alt="" height="64" src="https://assets-cdn.github.com/images/spinners/octocat-spinner-128.gif" width="64" /></p>
  <p>Loading…</p>
</div>

    <div id="show_issue" class="js-issues-results">


  <div
    id="partial-discussion-header"
    class="gh-header js-details-container js-socket-channel js-updatable-content issue"
    data-channel="rails/rails:issue:20977004"
    data-url="/rails/rails/issues/12537/show_partial?partial=issues%2Ftitle">

  <div class="gh-header-show ">
      <div class="gh-header-actions">
          <a href="/rails/rails/issues/new" class="btn btn-sm btn-primary right" data-hotkey="c">
            New issue
          </a>
      </div>

    <h1 class="gh-header-title">
      <span class="js-issue-title">Major performance regression when preloading has_many_through association</span>
      <span class="gh-header-number">#12537</span>
    </h1>
  </div>


  <div class="flex-table gh-header-meta">
    <div class="flex-table-item">
        <div class="state state-closed">
          <span class="octicon octicon-issue-closed "></span>
          Closed
        </div>
    </div>
    <div class="flex-table-item flex-table-item-primary">
        <a href="/njakobsen" class="author">njakobsen</a> opened this <span class="noun">Issue</span> <time datetime="2013-10-14T19:35:50Z" is="relative-time">Oct 14, 2013</time>
        &middot; 15 comments
    </div>
  </div>
</div>


    <div id="discussion_bucket" class="tab-content clearfix">
      <div id="partial-discussion-sidebar"
     class="discussion-sidebar js-socket-channel js-updatable-content"
     data-channel="rails/rails:issue:20977004"
     data-url="/rails/rails/issues/12537/show_partial?partial=issues%2Fsidebar">

  <div class="discussion-sidebar-item sidebar-labels js-discussion-sidebar-item">
  <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/rails/rails/issues/12537?partial=issues%2Fsidebar%2Fshow%2Flabels" class="js-issue-sidebar-form" data-form-nonce="9a3dc4e7f2b4d6410c95623b7687fcb6ae8f092f" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="_method" type="hidden" value="put" /><input name="authenticity_token" type="hidden" value="9IHsnOaS62HtcJW9pcTTl92QxcpShA9Aw1iscx0HPerETUR164bmTfWJBCehzT/kD7p1i1aGBo4WWTtGwHhUoA==" /></div>

  <h3 class="discussion-sidebar-heading">
    Labels
  </h3>


    <div class="labels css-truncate">
      <a href="/rails/rails/labels/activerecord" class="label css-truncate-target linked-labelstyle-0b02e1" title="activerecord">activerecord</a>

</div>

</form></div>

  <div class="discussion-sidebar-item sidebar-milestone js-discussion-sidebar-item">
  <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/rails/rails/issues/12537/set_milestone?partial=issues%2Fsidebar%2Fshow%2Fmilestone" class="js-issue-sidebar-form" data-form-nonce="9a3dc4e7f2b4d6410c95623b7687fcb6ae8f092f" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="_method" type="hidden" value="put" /><input name="authenticity_token" type="hidden" value="1CNPyPtMnnGRrUxFV4dI4HEUNWSiGEsABLpxu4+ry/0OWmwyqWgEsHqX/tOSUO06Vynv4SUPVzHBAsQpJ9dmCg==" /></div>

  <h3 class="discussion-sidebar-heading">
    Milestone
  </h3>


      <span class="progress-bar"><span class="progress" style="width: 73.50746268656717%">&nbsp;</span></span>
  <a title="5.0.0 [temp]" href="/rails/rails/milestones/5.0.0%20%5Btemp%5D" class="milestone-name css-truncate">
    <span class="css-truncate-target">5.0.0 [temp]</span>
  </a>

</form></div>

  <div class="discussion-sidebar-item sidebar-assignee js-discussion-sidebar-item">
  <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/rails/rails/issues/12537?partial=issues%2Fsidebar%2Fshow%2Fassignee" class="js-issue-sidebar-form" data-form-nonce="9a3dc4e7f2b4d6410c95623b7687fcb6ae8f092f" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="_method" type="hidden" value="put" /><input name="authenticity_token" type="hidden" value="BH6WQ4MhFMJmsOMuUTbOS0XS9NHUOKPQ58cOqXkqecIfvBAasnikP5B6hqO0xhU9z8UXdWD0L6vuTN9LqVSSPA==" /></div>

  <h3 class="discussion-sidebar-heading">
    Assignee
  </h3>


    <span class="css-truncate">
      No one assigned
</span>

</form></div>


  <div id="partial-users-participants" class="discussion-sidebar-item">
  <div class="participation">

    <h3 class="discussion-sidebar-heading">
      6 participants
    </h3>
    <div class="participation-avatars">
        <a class="participant-avatar tooltipped tooltipped-s" aria-label="njakobsen" href="/njakobsen"><img alt="@njakobsen" class="avatar" height="20" src="https://avatars2.githubusercontent.com/u/87623?v=3&amp;s=40" width="20" /> </a>
        <a class="participant-avatar tooltipped tooltipped-s" aria-label="tenderlove" href="/tenderlove"><img alt="@tenderlove" class="avatar" height="20" src="https://avatars1.githubusercontent.com/u/3124?v=3&amp;s=40" width="20" /> </a>
        <a class="participant-avatar tooltipped tooltipped-s" aria-label="rails-bot" href="/rails-bot"><img alt="@rails-bot" class="avatar" height="20" src="https://avatars3.githubusercontent.com/u/7468109?v=3&amp;s=40" width="20" /> </a>
        <a class="participant-avatar tooltipped tooltipped-s" aria-label="rafaelfranca" href="/rafaelfranca"><img alt="@rafaelfranca" class="avatar" height="20" src="https://avatars1.githubusercontent.com/u/47848?v=3&amp;s=40" width="20" /> </a>
        <a class="participant-avatar tooltipped tooltipped-s" aria-label="sgrif" href="/sgrif"><img alt="@sgrif" class="avatar" height="20" src="https://avatars0.githubusercontent.com/u/1529387?v=3&amp;s=40" width="20" /> </a>
        <a class="participant-avatar tooltipped tooltipped-s" aria-label="matthewd" href="/matthewd"><img alt="@matthewd" class="avatar" height="20" src="https://avatars1.githubusercontent.com/u/1034?v=3&amp;s=40" width="20" /> </a>
    </div>
  </div>
</div>



</div>


      <div class="discussion-timeline js-quote-selection-container ">

        <div class="js-discussion js-socket-channel" data-channel="rails/rails:marked-as-read:20977004">


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/njakobsen"><img alt="@njakobsen" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/87623?v=3&amp;s=96" width="48" /></a>
    <div id="issue-20977004"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="499ea8708296f4ca92c4c86688d07180">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/njakobsen" class="author">njakobsen</a>
    </strong>

    commented

    <a href="#issue-20977004" class="timestamp">
      <time datetime="2013-10-14T19:35:50Z" is="relative-time">Oct 14, 2013</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Between Rails 3.2 and 4.1.0 beta, the performance of preloading a has_many_through association has declined. A commit, <a href="https://github.com/rails/rails/pull/12090" class="issue-link js-issue-link" data-url="https://github.com/rails/rails/issues/12090" data-id="18807556" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#12090</a>, brought performance back to the range of one third the speed of Rails 3.2. However, between <a href="https://github.com/rails/rails/commit/a3dd738c38df634a46a2261a0de27fd31de7ae51" class="commit-link"><tt>a3dd738</tt></a> and the current codebase, the performance has again dropped approximately 5.5 times.</p>

<p>Here are some benchmarks.</p>

<pre><code>                                         3.2.14 - postgresql
                                              user     system      total        real
limit 100 has_many                         0.070000   0.000000   0.070000 (  0.086018)
limit 100 has_many_through                 0.030000   0.000000   0.030000 (  0.034133)
limit 100 double has_many_through          0.040000   0.010000   0.050000 (  0.057401)
limit 1000 has_many                        0.110000   0.000000   0.110000 (  0.122771)
limit 1000 has_many_through                0.230000   0.010000   0.240000 (  0.249680)
limit 1000 double has_many_through         0.460000   0.000000   0.460000 (  0.488896)

                                         4.1.0.beta (a3dd738c38df634a46a2261a0de27fd31de7ae51) - postgresql
                                              user     system      total        real
limit 100 has_many                         0.060000   0.000000   0.060000 (  0.070222)
limit 100 has_many_through                 0.070000   0.010000   0.080000 (  0.075542)
limit 100 double has_many_through          0.090000   0.010000   0.100000 (  0.107504)
limit 1000 has_many                        0.130000   0.000000   0.130000 (  0.136422)
limit 1000 has_many_through                0.680000   0.010000   0.690000 (  0.719953)
limit 1000 double has_many_through         1.320000   0.010000   1.330000 (  1.343767)

                                         4.1.0.beta - postgresql
                                              user     system      total        real
limit 100 has_many                         0.020000   0.000000   0.020000 (  0.025983)
limit 100 has_many_through                 0.130000   0.000000   0.130000 (  0.140196)
limit 100 double has_many_through          0.130000   0.010000   0.140000 (  0.149074)
limit 1000 has_many                        0.140000   0.000000   0.140000 (  0.152584)
limit 1000 has_many_through                3.490000   0.030000   3.520000 (  3.542585)
limit 1000 double has_many_through         7.250000   0.030000   7.280000 (  7.390997)
</code></pre>

<p>To be clear, the issue does not occur using eager_load, only when using preload.</p>

<p>A quick look at the call graph shows invocations of hash[]= have jumped from 8865 to almost 9.4 million. </p>

<pre><code># Rails 3.2.14     0.19%     0.19%   0.01    0.01    0.00    0.00    8865        Hash#[]=
# Rails 4.1.0 beta 76.78%    15.66%  114.09  23.27   0.00    90.82   9384486     Hash#[]=
</code></pre>

<p>I've created a gist for other to repeat my tests in case I've missed something major.<br>
<a href="https://gist.github.com/njakobsen/6393783">https://gist.github.com/njakobsen/6393783</a></p>

<p>Through a process of elimination, I identified a likely source of the regression to this commit <a href="https://github.com/rails/rails/commit/e5299c1ef693ef434f55811027a7da975cd55ba5" class="commit-link"><tt>e5299c1</tt></a>. All subsequent commits that I tested exhibited the slow performance, all preceding commits I tested did not. I know <a href="https://github.com/tenderlove" class="user-mention">@tenderlove</a> has been working on preloader recently, reducing the number of objects that are created, perhaps he can shed some light onto the major structural he's been applying, and how we might help optimize this section of code.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/tenderlove"><img alt="@tenderlove" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/3124?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-26283955"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="8a960464851e2ea72bb77d44be54aaa8">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/tenderlove" class="author">tenderlove</a>
    </strong>

    commented

    <a href="#issuecomment-26283955" class="timestamp">
      <time datetime="2013-10-14T19:57:44Z" is="relative-time">Oct 14, 2013</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Thanks for reporting this.  I believe the regression is from <a href="https://github.com/rails/rails/blob/828134b7561bf4473580d76bd8d7ae97e9b1db92/activerecord/lib/active_record/associations/preloader/through_association.rb#L47-L51">these lines</a>, which as basically for ensuring that the preloaded records maintain the same order that they had from the database.  Removing this will fix the regression, but break some tests.  I'm trying to figure out a better algorithm now. :-(</p>
      </div>
    </div>

  </div>
</div>

  </div>




  <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-19b871a">
      <span class="discussion-item-icon">
        <span class="octicon octicon-bookmark "></span>
      </span>

      <img alt="@tenderlove" class="avatar" height="16" src="https://avatars2.githubusercontent.com/u/3124?v=3&amp;s=32" width="16" />
      <a href="/tenderlove" class="author" truncate="true">tenderlove</a>

      referenced
      this issue
      from a commit
      <a href="#ref-commit-19b871a" class="timestamp">
        <time datetime="2013-10-14T20:05:01Z" is="relative-time">Oct 14, 2013</time>
      </a>
    </div>

    <table class="timeline-commits">


<tr class="commit js-details-container js-socket-channel js-updatable-content"
    data-channel="rails/rails:commit:19b871a0902c4ec3e460a38f41583a7855edd81a"
    data-url="/rails/rails/commit/19b871a0902c4ec3e460a38f41583a7855edd81a/show_partial?partial=commit%2Fcondensed"
  >

  <td class="commit-icon">
      <span class="octicon octicon-git-commit "></span>
  </td>

    <td class="commit-gravatar">
      <a href="/tenderlove"><img alt="@tenderlove" class="avatar avatar-small" height="16" src="https://avatars2.githubusercontent.com/u/3124?v=3&amp;s=32" width="16" /></a>
    </td>

    <td class="commit-author">
      <strong><a href="/tenderlove" class="author" rel="contributor">tenderlove</a></strong>
    </td>

  <td class="commit-message">
      <code><a href="/rails/rails/commit/19b871a0902c4ec3e460a38f41583a7855edd81a" class="message" data-pjax="true" title="only calculate offset index once. #12537">only calculate offset index once.</a> <a href="https://github.com/rails/rails/issues/12537" class="issue-link js-issue-link" data-url="https://github.com/rails/rails/issues/12537" data-id="20977004" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#12537</a></code>


  </td>

  <td class="commit-meta">


        <code><a href="/rails/rails/commit/19b871a0902c4ec3e460a38f41583a7855edd81a" class="commit-id">19b871a</a></code>
  </td>
</tr>

    </table>
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/tenderlove"><img alt="@tenderlove" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/3124?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-26284569"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="e7a649d2ad78db34f6280b1ed3018df7">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/tenderlove" class="author">tenderlove</a>
    </strong>

    commented

    <a href="#issuecomment-26284569" class="timestamp">
      <time datetime="2013-10-14T20:06:46Z" is="relative-time">Oct 14, 2013</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>I've pushed a commit that seems to mostly fix the performance (for me anyway).  <a href="https://gist.github.com/tenderlove/6981363">Here's the test I used</a>.  I still think there's a better way to write this code such that I don't have to manually calculate offsets like this, but I haven't figured it out yet.  :-(</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/njakobsen"><img alt="@njakobsen" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/87623?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-26288896"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="f5d736f9911015eb7d7953fa2f0d97e6">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/njakobsen" class="author">njakobsen</a>
    </strong>

    commented

    <a href="#issuecomment-26288896" class="timestamp">
      <time datetime="2013-10-14T21:07:50Z" is="relative-time">Oct 14, 2013</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p><img class="emoji" title=":heart:" alt=":heart:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2764.png" height="20" width="20" align="absmiddle"> That fixed it for me; a much more reasonable 72k invocations of hash[]= now. I have an app that does a lot of eager/preloading as it indexes for solr, so I've been trying to follow along with your commits to see how close to Rails 3.2 speeds they get. Unfortunately I'm not familiar enough with the code to find anything but the major hotspots. Closing the remaining gap looks like it'll come from micro-optimizations. I'll keep the issue open while you're still working on a beautiful solution. Feel free to close it if you're done.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/tenderlove"><img alt="@tenderlove" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/3124?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-26289790"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="f8e29f9827906386a3570a0cc26fb78f">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/tenderlove" class="author">tenderlove</a>
    </strong>

    commented

    <a href="#issuecomment-26289790" class="timestamp">
      <time datetime="2013-10-14T21:19:54Z" is="relative-time">Oct 14, 2013</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p><a href="https://github.com/njakobsen" class="user-mention">@njakobsen</a> I <em>think</em> I've found a better algorithm for doing this.  Right now, we walk down the tree, left, center, then right.  We're trying to build a hash with the left records as keys, and the right records as values, but that loses the ordering.  If we could go from the right back to the left, we could keep the ordering from the db and eliminate this "indexing" rigamarole.  I'm working on a spike now.</p>

<p>Really, thank you very much for reporting this.  I was worried that my changes had perf impact, but didn't have a good way to test.</p>

<p>Edit: just to clarify, the reason the right ordering is lost is because the center records could be ordered in any order.  We can't simply loop over the center records asking them for the RHS records as the <em>center</em> records will not share order with the RHS records.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/njakobsen"><img alt="@njakobsen" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/87623?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-26304952"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="97df367f942d19bc0862c72633b4acb8">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/njakobsen" class="author">njakobsen</a>
    </strong>

    commented

    <a href="#issuecomment-26304952" class="timestamp">
      <time datetime="2013-10-15T02:23:55Z" is="relative-time">Oct 15, 2013</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>I've had a chance to follow it through and I see your point. I tried a couple methods, but unfortunately ary &amp; ary is slower, hash.values_at uses the order from the arguments, not the receiver, and using Set is worse than both those methods. Like you said, the solution probably lies in reversing the direction and going from the rhs =&gt; middle =&gt; lhs. I'll wait for you to put up your spike and see if any lightbulbs turn on in my brain.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/tenderlove"><img alt="@tenderlove" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/3124?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-26442841"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="8a547ee6abd43745baf5914f6445cab6">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/tenderlove" class="author">tenderlove</a>
    </strong>

    commented

    <a href="#issuecomment-26442841" class="timestamp">
      <time datetime="2013-10-16T18:11:10Z" is="relative-time">Oct 16, 2013</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p><a href="https://github.com/njakobsen" class="user-mention">@njakobsen</a> I spent about 4 hours on the spike and couldn't get it to pass the tests.  I'm letting my brain rest for a bit before tackling again (though I think we should leave this ticket open until it's fixed).</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/njakobsen"><img alt="@njakobsen" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/87623?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-26468746"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="34ce9d3e1f901543427fe222596e89bb">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/njakobsen" class="author">njakobsen</a>
    </strong>

    commented

    <a href="#issuecomment-26468746" class="timestamp">
      <time datetime="2013-10-16T23:41:30Z" is="relative-time">Oct 16, 2013</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>I played around with organizing the incoming rhs records into a hash whose values are lists of the associated owners. Then we go through <code>@preloaded_records</code> and populate the <code>records_by_owner</code> hash in the correct order. Unfortunately this seems to have the same performance as your method. How extensive was your spike? I'm wondering if there's really any more performance to be gained in the few lines I tackled. About 25% of the total time was spent the section pasted below, but about 95% of the total time is spent in the entire function, so there's another 70% somewhere before it. </p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">def</span> <span class="pl-en">associated_records_by_owner</span>(<span class="pl-smi">preloader</span>)
  <span class="pl-c">#...</span>
  middle_to_pl <span class="pl-k">=</span> preloaders.each_with_object({}) <span class="pl-k">do </span>|<span class="pl-smi">pl</span>,<span class="pl-smi">h</span>|
    pl.owners.each { |<span class="pl-smi">middle</span>|
      h[middle] <span class="pl-k">=</span> pl
    }
  <span class="pl-k">end</span>
  <span class="pl-c"># Changes begin here</span>
  rhs_to_owners <span class="pl-k">=</span> <span class="pl-c1">Hash</span>.<span class="pl-k">new</span> {|<span class="pl-smi">h</span>,<span class="pl-smi">rhs</span>| h[rhs] <span class="pl-k">=</span> [] }

  through_records.each <span class="pl-k">do </span>|<span class="pl-smi">lhs</span>,<span class="pl-smi">center</span>|
    pl_to_middle <span class="pl-k">=</span> center.group_by { |<span class="pl-smi">record</span>| middle_to_pl[record] }

    pl_to_middle.each <span class="pl-k">do </span>|<span class="pl-smi">pl</span>, <span class="pl-smi">middles</span>|
      middles.each <span class="pl-k">do </span>|<span class="pl-smi">mid</span>|
        association <span class="pl-k">=</span> mid.association source_reflection.name
        <span class="pl-c1">Array</span>(association.reader).each {|<span class="pl-smi">rhs</span>| rhs_to_owners[rhs] <span class="pl-k">&lt;&lt;</span> lhs }
      <span class="pl-k">end</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>

  records_by_owner <span class="pl-k">=</span> <span class="pl-c1">Hash</span>.<span class="pl-k">new</span> {|<span class="pl-smi">h</span>,<span class="pl-smi">record</span>| h[record] <span class="pl-k">=</span> [] }

  <span class="pl-smi">@preloaded_records</span>.each <span class="pl-k">do </span>|<span class="pl-smi">rhs</span>|
    rhs_to_owners[rhs].each <span class="pl-k">do </span>|<span class="pl-smi">owner</span>|
      records_by_owner[owner] <span class="pl-k">&lt;&lt;</span> rhs
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>

  <span class="pl-k">return</span> records_by_owner
<span class="pl-k">end</span></pre></div>
      </div>
    </div>

  </div>
</div>

  </div>




  <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-ee46f1d">
      <span class="discussion-item-icon">
        <span class="octicon octicon-bookmark "></span>
      </span>

      <img alt="@tenderlove" class="avatar" height="16" src="https://avatars2.githubusercontent.com/u/3124?v=3&amp;s=32" width="16" />
      <a href="/tenderlove" class="author" truncate="true">tenderlove</a>

      referenced
      this issue
      from a commit
      <a href="#ref-commit-ee46f1d" class="timestamp">
        <time datetime="2013-10-21T22:44:53Z" is="relative-time">Oct 21, 2013</time>
      </a>
    </div>

    <table class="timeline-commits">


<tr class="commit js-details-container js-socket-channel js-updatable-content"
    data-channel="rails/rails:commit:ee46f1d5d2a8825de2d4973fb0301f2d85986e73"
    data-url="/rails/rails/commit/ee46f1d5d2a8825de2d4973fb0301f2d85986e73/show_partial?partial=commit%2Fcondensed"
  >

  <td class="commit-icon">
      <span class="octicon octicon-git-commit "></span>
  </td>

    <td class="commit-gravatar">
      <a href="/tenderlove"><img alt="@tenderlove" class="avatar avatar-small" height="16" src="https://avatars2.githubusercontent.com/u/3124?v=3&amp;s=32" width="16" /></a>
    </td>

    <td class="commit-author">
      <strong><a href="/tenderlove" class="author" rel="contributor">tenderlove</a></strong>
    </td>

  <td class="commit-message">
      <code><a href="/rails/rails/commit/ee46f1d5d2a8825de2d4973fb0301f2d85986e73" class="message" data-pjax="true" title="Merge branch &#39;master&#39; into joindep

* master: (44 commits)
  grammar fix (reverted in e9a1ecd)
  Revert &quot;fixed a doc bug in the CHANGELOG.md s/does no longer depend on/no longer depends on/&quot;
  Add missed require making `enable_warnings` available
  Prepare generated Gemfile for Capistrano 3
  Added --model-name option scaffold_controller_generator.
  read the association instead of sending
  we should have unique sponsorable ids in the fixtures at least
  simplify populating the ordering hash
  the preloader for the RHS has all the preloaded records, so ask it
  only calculate offset index once. #12537
  Remove size alias for length validation
  Fix `singleton_class?`
  Minor Refactoring to `NumberHelper#number_to_human`
  `$SAFE = 4;` has been removed with Ruby 2.1
  scope_chain should not be mutated for other reflections
  Remove `default_primary_key_type`  and extract contains of `native_database_types` to a constant since they aren&#39;t conditional now in SQLite3Adapter. Makes it more like other adapters.
  cleanup changelog entry format. [ci skip]
  Extract a function to determine if the default value is a function
  Push default_function to superclass to avoid method check
  Dump the default function when the primary key is uuid
  ...

Conflicts:
  activerecord/lib/active_record/relation/finder_methods.rb">Merge branch 'master' into joindep</a></code>

        <span class="hidden-text-expander inline">
          <a href="#" class="js-details-target">&hellip;</a>
        </span>
        <div class="commit-desc"><pre class="text-small">* master: (44 commits)
  grammar fix (reverted in <a href="https://github.com/rails/rails/commit/e9a1ecd583f3993c696a1cc95e182dcbe346553b" class="commit-link"><tt>e9a1ecd</tt></a>)
  Revert "fixed a doc bug in the CHANGELOG.md s/does no longer depend on/no longer depends on/"
  Add missed require making `enable_warnings` available
  Prepare generated Gemfile for Capistrano 3
  Added --model-name option scaffold_controller_generator.
  read the association instead of sending
  we should have unique sponsorable ids in the fixtures at least
  simplify populating the ordering hash
  the preloader for the RHS has all the preloaded records, so ask it
  only calculate offset index once. <a href="https://github.com/rails/rails/issues/12537" class="issue-link js-issue-link" data-url="https://github.com/rails/rails/issues/12537" data-id="20977004" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#12537</a>
  Remove size alias for length validation
  Fix `singleton_class?`
  Minor Refactoring to `NumberHelper#number_to_human`
  `$SAFE = 4;` has been removed with Ruby 2.1
  scope_chain should not be mutated for other reflections
  Remove `default_primary_key_type`  and extract contains of `native_database_types` to a constant since they aren't conditional now in SQLite3Adapter. Makes it more like other adapters.
  cleanup changelog entry format. [ci skip]
  Extract a function to determine if the default value is a function
  Push default_function to superclass to avoid method check
  Dump the default function when the primary key is uuid
  ...

Conflicts:
  activerecord/lib/active_record/relation/finder_methods.rb</pre></div>

  </td>

  <td class="commit-meta">


        <code><a href="/rails/rails/commit/ee46f1d5d2a8825de2d4973fb0301f2d85986e73" class="commit-id">ee46f1d</a></code>
  </td>
</tr>

    </table>
  </div>







  <div class="discussion-item discussion-item-labeled">
    <div class="discussion-item-header" id="event-91761875">

      <span class="discussion-item-icon">
        <span class="octicon octicon-tag "></span>
      </span>
      <img alt="@tenderlove" class="avatar" height="16" src="https://avatars2.githubusercontent.com/u/3124?v=3&amp;s=32" width="16" />
      <a href="/tenderlove" class="author">tenderlove</a>
      added the <span class="label-color" style="background-color: #eb6420;"><a href="/rails/rails/labels/openacademy" style="color: #fff">openacademy</a></span> label <a href="https://github.com/rails/rails/issues/12537#event-91761875" class="timestamp"><time class="timestamp" datetime="2014-02-07T18:31:08Z" is="relative-time">Feb 7, 2014</time></a>
    </div>
  </div>








  <div class="discussion-item discussion-item-labeled">
    <div class="discussion-item-header" id="event-125181260">

      <span class="discussion-item-icon">
        <span class="octicon octicon-tag "></span>
      </span>
      <img alt="@njakobsen" class="avatar" height="16" src="https://avatars1.githubusercontent.com/u/87623?v=3&amp;s=32" width="16" />
      <a href="/njakobsen" class="author">njakobsen</a>
      added the <span class="label-color" style="background-color: #444444;"><a href="/rails/rails/labels/stale" style="color: #fff">stale</a></span> label <a href="https://github.com/rails/rails/issues/12537#event-125181260" class="timestamp"><time class="timestamp" datetime="2014-05-27T16:28:30Z" is="relative-time">May 27, 2014</time></a>
    </div>
  </div>



  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/rails-bot"><img alt="@rails-bot" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/7468109?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-44300054"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container collaborator-comment"
     data-body-version="eef72a662b4d790b13a21ba9ed012557">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Collaborator</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/rails-bot" class="author">rails-bot</a>
    </strong>

    commented

    <a href="#issuecomment-44300054" class="timestamp">
      <time datetime="2014-05-27T16:28:31Z" is="relative-time">May 27, 2014</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>This issue has been automatically marked as stale because it has not been commented on for at least<br>
three months.</p>

<p>The resources of the Rails team are limited, and so we are asking for your help.</p>

<p>If you can still reproduce this error on the <code>4-1-stable</code>, <code>4-0-stable</code> branches or on <code>master</code>,<br>
please reply with all of the information you have about it in order to keep the issue open.</p>

<p>Thank you for all your contributions.</p>
      </div>
    </div>

  </div>
</div>

  </div>




  <div class="discussion-item discussion-item-demilestoned">
    <div class="discussion-item-header" id="event-153754058">

      <span class="discussion-item-icon">
        <span class="octicon octicon-milestone "></span>
      </span>
      <img alt="@rafaelfranca" class="avatar" height="16" src="https://avatars2.githubusercontent.com/u/47848?v=3&amp;s=32" width="16" />
      <a href="/rafaelfranca" class="author">rafaelfranca</a>
       modified the milestone: <a href="/rails/rails/milestones/4.2.0" class="discussion-item-entity" title="by rafaelfranca at 2014-08-18 02:05:17">4.2.0</a>, <a href="/rails/rails/milestones/5.0.0" class="discussion-item-entity" title="by rafaelfranca at 2014-08-18 02:05:17">5.0.0</a>  <a href="https://github.com/rails/rails/issues/12537#event-153754058" class="timestamp"><time class="timestamp" datetime="2014-08-18T02:05:17Z" is="relative-time">Aug 18, 2014</time></a>
    </div>
  </div>








  <div class="discussion-item discussion-item-unlabeled">
    <div class="discussion-item-header" id="event-154598287">

      <span class="discussion-item-icon">
        <span class="octicon octicon-tag "></span>
      </span>
      <img alt="@rafaelfranca" class="avatar" height="16" src="https://avatars2.githubusercontent.com/u/47848?v=3&amp;s=32" width="16" />
      <a href="/rafaelfranca" class="author">rafaelfranca</a>
      removed the <span class="label-color" style="background-color: #444444;"><a href="/rails/rails/labels/stale" style="color: #fff">stale</a></span> label <a href="https://github.com/rails/rails/issues/12537#event-154598287" class="timestamp"><time class="timestamp" datetime="2014-08-19T17:51:22Z" is="relative-time">Aug 19, 2014</time></a>
    </div>
  </div>



  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/rafaelfranca"><img alt="@rafaelfranca" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/47848?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-52672265"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="8c7135fa10dc3a149abb6369ba5d2274">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/rafaelfranca" class="author">rafaelfranca</a>
    </strong>

    commented

    <a href="#issuecomment-52672265" class="timestamp">
      <time datetime="2014-08-19T17:51:46Z" is="relative-time">Aug 19, 2014</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Could you check the performance with current master?</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/njakobsen"><img alt="@njakobsen" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/87623?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-53108307"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="2b36713c7d94dd8c7c07fd2951dbb640">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/njakobsen" class="author">njakobsen</a>
    </strong>

    commented

    <a href="#issuecomment-53108307" class="timestamp">
      <time datetime="2014-08-22T19:18:05Z" is="relative-time">Aug 22, 2014</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <pre><code>                                         4.2.0.alpha - postgresql
                                               user     system      total        real
limit 100 has_many                         0.020000   0.000000   0.020000 (  0.019844)
limit 100 has_many_through                 0.060000   0.000000   0.060000 (  0.069341)
limit 100 double has_many_through          0.120000   0.000000   0.120000 (  0.125350)
limit 1000 has_many                        0.120000   0.010000   0.130000 (  0.136233)
limit 1000 has_many_through                0.670000   0.000000   0.670000 (  0.800994)
limit 1000 double has_many_through         1.260000   0.010000   1.270000 (  1.515393)

                                         3.2.18 - postgresql
                                               user     system      total        real
limit 100 has_many                         0.010000   0.000000   0.010000 (  0.011362)
limit 100 has_many_through                 0.020000   0.000000   0.020000 (  0.028196)
limit 100 double has_many_through          0.040000   0.000000   0.040000 (  0.045982)
limit 1000 has_many                        0.080000   0.000000   0.080000 (  0.132761)
limit 1000 has_many_through                0.190000   0.000000   0.190000 (  0.210479)
limit 1000 double has_many_through         0.370000   0.000000   0.370000 (  0.404050)
</code></pre>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/rafaelfranca"><img alt="@rafaelfranca" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/47848?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-53108754"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="a06ec0a8f1a6204a6fce2255d669acf6">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/rafaelfranca" class="author">rafaelfranca</a>
    </strong>

    commented

    <a href="#issuecomment-53108754" class="timestamp">
      <time datetime="2014-08-22T19:21:57Z" is="relative-time">Aug 22, 2014</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p><a href="https://github.com/njakobsen" class="user-mention">@njakobsen</a> could you use bechmark-ips so we can see the standard deviation?</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/njakobsen"><img alt="@njakobsen" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/87623?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-53116115"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="ad7141be64387a944925855fd8e511f5">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/njakobsen" class="author">njakobsen</a>
    </strong>

    commented

    <a href="#issuecomment-53116115" class="timestamp">
      <time datetime="2014-08-22T20:27:50Z" is="relative-time">Aug 22, 2014</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <pre><code>ActiveRecord 3.2.18
Calculating -------------------------------------
limit 100 has_many                  7 i/100ms
limit 100 has_many_through          3 i/100ms
limit 100 double has_many_through   1 i/100ms
limit 1000 has_many                 1 i/100ms
limit 1000 has_many_through         1 i/100ms
limit 1000 double has_many_through  1 i/100ms
-------------------------------------------------
limit 100 has_many                  87.5 (±26.3%) i/s -        385 in   5.046093s
limit 100 has_many_through          37.7 (±23.9%) i/s -        171 in   5.057724s
limit 100 double has_many_through   22.9 (±21.8%) i/s -        105 in   5.021097s
limit 1000 has_many                 10.0 (±30.0%) i/s -         45 in   5.013717s
limit 1000 has_many_through          3.8 (±26.6%) i/s -         18 in   5.174370s
limit 1000 double has_many_through   2.1  (±0.0%) i/s -         10 in   5.061884s


ActiveRecord 4.2.0.alpha
Calculating -------------------------------------
limit 100 has_many                  4 i/100ms
limit 100 has_many_through          1 i/100ms
limit 100 double has_many_through   1 i/100ms
limit 1000 has_many                 1 i/100ms
limit 1000 has_many_through         1 i/100ms
limit 1000 double has_many_through  1 i/100ms
-------------------------------------------------
limit 100 has_many                  61.5 (±29.3%) i/s -       2008 in  40.109908s
limit 100 has_many_through          12.2 (±24.6%) i/s -        444 in  40.047831s
limit 100 double has_many_through    6.7 (±29.8%) i/s -        251 in  40.171552s
limit 1000 has_many                  6.5 (±30.8%) i/s -        238 in  40.083358s
limit 1000 has_many_through          1.1  (±0.0%) i/s -         45 in  40.288512s
limit 1000 double has_many_through   0.6  (±0.0%) i/s -         25 in  40.958853s
</code></pre>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/rafaelfranca"><img alt="@rafaelfranca" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/47848?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-55462750"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="5d19b2572b6c1c1f1f05b7f039e24841">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/rafaelfranca" class="author">rafaelfranca</a>
    </strong>

    commented

    <a href="#issuecomment-55462750" class="timestamp">
      <time datetime="2014-09-12T21:24:44Z" is="relative-time">Sep 12, 2014</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>OMG! Still slower.</p>
      </div>
    </div>

  </div>
</div>

  </div>




  <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-b348115">
      <span class="discussion-item-icon">
        <span class="octicon octicon-bookmark "></span>
      </span>

      <img alt="@yuroyoro" class="avatar" height="16" src="https://avatars1.githubusercontent.com/u/18634?v=3&amp;s=32" width="16" />
      <a href="/yuroyoro" class="author" truncate="true">yuroyoro</a>

      referenced
      this issue
      from a commit
        in yuroyoro/rails
      <a href="#ref-commit-b348115" class="timestamp">
        <time datetime="2015-03-06T06:33:48Z" is="relative-time">Mar 6, 2015</time>
      </a>
    </div>

    <table class="timeline-commits">


<tr class="commit js-details-container js-socket-channel js-updatable-content"
    data-channel="rails/rails:commit:b348115f1d0cc8d3aa363568b6692ad312941a91"
    data-url="/rails/rails/commit/b348115f1d0cc8d3aa363568b6692ad312941a91/show_partial?partial=commit%2Fcondensed"
  >

  <td class="commit-icon">
      <span class="octicon octicon-git-commit "></span>
  </td>

    <td class="commit-gravatar">
      <a href="/yuroyoro"><img alt="@yuroyoro" class="avatar avatar-small" height="16" src="https://avatars1.githubusercontent.com/u/18634?v=3&amp;s=32" width="16" /></a>
    </td>

    <td class="commit-author">
      <strong><a href="/yuroyoro" class="author" rel="contributor">yuroyoro</a></strong>
    </td>

  <td class="commit-message">
      <code><a href="/yuroyoro/rails/commit/b348115f1d0cc8d3aa363568b6692ad312941a91" class="message" data-pjax="true" title="Read already loaded association records from association.target

For performance, Avoid instantiate CollectionProxy.
Fixes #12537">Read already loaded association records from association.target</a></code>

        <span class="hidden-text-expander inline">
          <a href="#" class="js-details-target">&hellip;</a>
        </span>
        <div class="commit-desc"><pre class="text-small">For performance, Avoid instantiate CollectionProxy.
Fixes <a href="https://github.com/rails/rails/issues/12537" class="issue-link js-issue-link" data-url="https://github.com/rails/rails/issues/12537" data-id="20977004" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#12537</a></pre></div>

  </td>

  <td class="commit-meta">


        <code><a href="/yuroyoro/rails/commit/b348115f1d0cc8d3aa363568b6692ad312941a91" class="commit-id">b348115</a></code>
  </td>
</tr>

    </table>
  </div>



      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-pullrequest-60617671">
      <span class="discussion-item-icon">
        <span class="octicon octicon-bookmark "></span>
      </span>

      <img alt="@yuroyoro" class="avatar" height="16" src="https://avatars1.githubusercontent.com/u/18634?v=3&amp;s=32" width="16" />
      <a href="/yuroyoro" class="author" truncate="true">yuroyoro</a>

      referenced
      this issue
      <a class="timestamp" href="#ref-pullrequest-60617671">
        <time datetime="2015-03-11T06:56:18Z" is="relative-time">Mar 11, 2015</time>
      </a>
    </div>

      <span class="state state-closed right">
          <span class="octicon octicon-git-pull-request "></span>
        Closed
      </span>



    <h3 class="discussion-item-ref-title">
      <a href="/rails/rails/issues/19283" class="title-link">
        Fix #12537  performance regression when preloading has_many_through association
        <span class="issue-num">#19283</span>
</a>    </h3>

  </div>






  <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-062b84d">
      <span class="discussion-item-icon">
        <span class="octicon octicon-bookmark "></span>
      </span>

      <img alt="@yuroyoro" class="avatar" height="16" src="https://avatars1.githubusercontent.com/u/18634?v=3&amp;s=32" width="16" />
      <a href="/yuroyoro" class="author" truncate="true">yuroyoro</a>

      referenced
      this issue
      from a commit
        in yuroyoro/rails
      <a href="#ref-commit-062b84d" class="timestamp">
        <time datetime="2015-03-20T04:55:42Z" is="relative-time">Mar 20, 2015</time>
      </a>
    </div>

    <table class="timeline-commits">


<tr class="commit js-details-container js-socket-channel js-updatable-content"
    data-channel="rails/rails:commit:062b84d02d3c511005efd06160d70823da1f9727"
    data-url="/rails/rails/commit/062b84d02d3c511005efd06160d70823da1f9727/show_partial?partial=commit%2Fcondensed"
  >

  <td class="commit-icon">
      <span class="octicon octicon-git-commit "></span>
  </td>

    <td class="commit-gravatar">
      <a href="/yuroyoro"><img alt="@yuroyoro" class="avatar avatar-small" height="16" src="https://avatars1.githubusercontent.com/u/18634?v=3&amp;s=32" width="16" /></a>
    </td>

    <td class="commit-author">
      <strong><a href="/yuroyoro" class="author" rel="contributor">yuroyoro</a></strong>
    </td>

  <td class="commit-message">
      <code><a href="/yuroyoro/rails/commit/062b84d02d3c511005efd06160d70823da1f9727" class="message" data-pjax="true" title="Read already loaded association records from association.target

For performance, Avoid instantiate CollectionProxy.
Fixes #12537">Read already loaded association records from association.target</a></code>

        <span class="hidden-text-expander inline">
          <a href="#" class="js-details-target">&hellip;</a>
        </span>
        <div class="commit-desc"><pre class="text-small">For performance, Avoid instantiate CollectionProxy.
Fixes <a href="https://github.com/rails/rails/issues/12537" class="issue-link js-issue-link" data-url="https://github.com/rails/rails/issues/12537" data-id="20977004" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#12537</a></pre></div>

  </td>

  <td class="commit-meta">


        <code><a href="/yuroyoro/rails/commit/062b84d02d3c511005efd06160d70823da1f9727" class="commit-id">062b84d</a></code>
  </td>
</tr>

    </table>
  </div>



      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-pullrequest-63163879">
      <span class="discussion-item-icon">
        <span class="octicon octicon-bookmark "></span>
      </span>

      <img alt="@yuroyoro" class="avatar" height="16" src="https://avatars1.githubusercontent.com/u/18634?v=3&amp;s=32" width="16" />
      <a href="/yuroyoro" class="author" truncate="true">yuroyoro</a>

      referenced
      this issue
      <a class="timestamp" href="#ref-pullrequest-63163879">
        <time datetime="2015-03-20T05:15:31Z" is="relative-time">Mar 20, 2015</time>
      </a>
    </div>

      <span class="state state-merged right">
          <span class="octicon octicon-git-pull-request "></span>
        Merged
      </span>



    <h3 class="discussion-item-ref-title">
      <a href="/rails/rails/issues/19423" class="title-link">
        Fix #12537 performance regression when preloading has_many_through association
        <span class="issue-num">#19423</span>
</a>    </h3>

  </div>






  <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-97a6aba">
      <span class="discussion-item-icon">
        <span class="octicon octicon-bookmark "></span>
      </span>

      <img alt="@yuroyoro" class="avatar" height="16" src="https://avatars1.githubusercontent.com/u/18634?v=3&amp;s=32" width="16" />
      <a href="/yuroyoro" class="author" truncate="true">yuroyoro</a>

      referenced
      this issue
      from a commit
        in yuroyoro/rails
      <a href="#ref-commit-97a6aba" class="timestamp">
        <time datetime="2015-03-20T09:02:07Z" is="relative-time">Mar 20, 2015</time>
      </a>
    </div>

    <table class="timeline-commits">


<tr class="commit js-details-container js-socket-channel js-updatable-content"
    data-channel="rails/rails:commit:97a6abaaae2e25aff9ec1503cc4192f06fd74ea4"
    data-url="/rails/rails/commit/97a6abaaae2e25aff9ec1503cc4192f06fd74ea4/show_partial?partial=commit%2Fcondensed"
  >

  <td class="commit-icon">
      <span class="octicon octicon-git-commit "></span>
  </td>

    <td class="commit-gravatar">
      <a href="/yuroyoro"><img alt="@yuroyoro" class="avatar avatar-small" height="16" src="https://avatars1.githubusercontent.com/u/18634?v=3&amp;s=32" width="16" /></a>
    </td>

    <td class="commit-author">
      <strong><a href="/yuroyoro" class="author" rel="contributor">yuroyoro</a></strong>
    </td>

  <td class="commit-message">
      <code><a href="/yuroyoro/rails/commit/97a6abaaae2e25aff9ec1503cc4192f06fd74ea4" class="message" data-pjax="true" title="Read already loaded association records from association.target

For performance, Avoid instantiate CollectionProxy.
Fixes #12537">Read already loaded association records from association.target</a></code>

        <span class="hidden-text-expander inline">
          <a href="#" class="js-details-target">&hellip;</a>
        </span>
        <div class="commit-desc"><pre class="text-small">For performance, Avoid instantiate CollectionProxy.
Fixes <a href="https://github.com/rails/rails/issues/12537" class="issue-link js-issue-link" data-url="https://github.com/rails/rails/issues/12537" data-id="20977004" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#12537</a></pre></div>

  </td>

  <td class="commit-meta">
        <a href="/yuroyoro/rails/commit/97a6abaaae2e25aff9ec1503cc4192f06fd74ea4#comments"><span aria-label="View comments on this commit" class="octicon octicon-comment-discussion "></span></a>


        <code><a href="/yuroyoro/rails/commit/97a6abaaae2e25aff9ec1503cc4192f06fd74ea4" class="commit-id">97a6aba</a></code>
  </td>
</tr>

    </table>
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/rails-bot"><img alt="@rails-bot" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/7468109?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-84140203"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container collaborator-comment"
     data-body-version="bc3b0ff93bc8dd4aa37d0126791518d9">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Collaborator</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/rails-bot" class="author">rails-bot</a>
    </strong>

    commented

    <a href="#issuecomment-84140203" class="timestamp">
      <time datetime="2015-03-20T20:46:24Z" is="relative-time">Mar 20, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>This issue has been automatically marked as stale because it has not been commented on for at least<br>
three months.</p>

<p>The resources of the Rails team are limited, and so we are asking for your help.</p>

<p>If you can still reproduce this error on the <code>4-2-stable</code>, <code>4-1-stable</code> branches or on <code>master</code>,<br>
please reply with all of the information you have about it in order to keep the issue open.</p>

<p>Thank you for all your contributions.</p>
      </div>
    </div>

  </div>
</div>

  </div>






  <div class="discussion-item discussion-item-labeled">
    <div class="discussion-item-header" id="event-260784258">

      <span class="discussion-item-icon">
        <span class="octicon octicon-tag "></span>
      </span>
      <img alt="@rails-bot" class="avatar" height="16" src="https://avatars0.githubusercontent.com/u/7468109?v=3&amp;s=32" width="16" />
      <a href="/rails-bot" class="author">rails-bot</a>
      added the <span class="label-color" style="background-color: #444444;"><a href="/rails/rails/labels/stale" style="color: #fff">stale</a></span> label <a href="https://github.com/rails/rails/issues/12537#event-260784258" class="timestamp"><time class="timestamp" datetime="2015-03-20T20:46:24Z" is="relative-time">Mar 20, 2015</time></a>
    </div>
  </div>



  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/njakobsen"><img alt="@njakobsen" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/87623?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-85863391"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="e8f87975b5a989cd5e2ed3f6797729e7">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/njakobsen" class="author">njakobsen</a>
    </strong>

    commented

    <a href="#issuecomment-85863391" class="timestamp">
      <time datetime="2015-03-25T06:05:07Z" is="relative-time">Mar 25, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Here's the latest in case anyone is interested.</p>

<pre><code>ActiveRecord 3.2.19
Calculating -------------------------------------
limit 100 has_many                                   9 i/100ms
limit 100 has_many_through                           2 i/100ms
limit 100 double has_many_through                    2 i/100ms
limit 1000 has_many                                  1 i/100ms
limit 1000 has_many_through                          1 i/100ms
limit 1000 double has_many_through                   1 i/100ms
-------------------------------------------------
limit 100 has_many                               101.0 (±13.9%)   i/s -        495 in   5.015563s
limit 100 has_many_through                        39.8 (±15.1%)   i/s -        194 in   5.033930s
limit 100 double has_many_through                 23.0 (±8.7%)    i/s -        116 in   5.116024s
limit 1000 has_many                               11.0 (±9.1%)    i/s -         54 in   5.013754s
limit 1000 has_many_through                        4.2 (±0.0%)    i/s -         21 in   5.005129s
limit 1000 double has_many_through                 2.4 (±0.0%)    i/s -         12 in   5.021382s


ActiveRecord 4.1.0.beta1
Calculating -------------------------------------
limit 100 has_many                                   7 i/100ms
limit 100 has_many_through                           1 i/100ms
limit 100 double has_many_through                    1 i/100ms
limit 1000 has_many                                  1 i/100ms
limit 1000 has_many_through                          1 i/100ms
limit 1000 double has_many_through                   1 i/100ms
-------------------------------------------------
limit 100 has_many                                95.5 (±11.5%)   i/s -        476 in   5.071079s
limit 100 has_many_through                        15.2 (±19.8%)   i/s -         66 in   5.049036s
limit 100 double has_many_through                  9.5 (±10.5%)   i/s -         47 in   5.074076s
limit 1000 has_many                               10.3 (±19.4%)   i/s -         41 in   4.999739s
limit 1000 has_many_through                        1.6 (±0.0%)    i/s -          9 in   5.520001s
limit 1000 double has_many_through                 0.9 (±0.0%)    i/s -          5 in   5.828492s


ActiveRecord 5.0.0.alpha
Calculating -------------------------------------
limit 100 has_many                                   6 i/100ms
limit 100 has_many_through                           1 i/100ms
limit 100 double has_many_through                    1 i/100ms
limit 1000 has_many                                  1 i/100ms
limit 1000 has_many_through                          1 i/100ms
limit 1000 double has_many_through                   1 i/100ms
-------------------------------------------------
limit 100 has_many                                78.3 (±17.9%)   i/s -        378 in   5.044705s
limit 100 has_many_through                         6.4 (±31.3%)   i/s -         28 in   5.115270s
limit 100 double has_many_through                  4.4 (±0.0%)    i/s -         22 in   5.085810s
limit 1000 has_many                                8.9 (±11.3%)   i/s -         44 in   5.081750s
limit 1000 has_many_through                        0.8 (±0.0%)    i/s -          4 in   5.292386s
limit 1000 double has_many_through                 0.4 (±0.0%)    i/s -          3 in   6.702794s
</code></pre>
      </div>
    </div>

  </div>
</div>

  </div>






  <div class="discussion-item discussion-item-unlabeled">
    <div class="discussion-item-header" id="event-264776203">

      <span class="discussion-item-icon">
        <span class="octicon octicon-tag "></span>
      </span>
      <img alt="@sgrif" class="avatar" height="16" src="https://avatars3.githubusercontent.com/u/1529387?v=3&amp;s=32" width="16" />
      <a href="/sgrif" class="author">sgrif</a>
      removed the <span class="label-color" style="background-color: #444444;"><a href="/rails/rails/labels/stale" style="color: #fff">stale</a></span> label <a href="https://github.com/rails/rails/issues/12537#event-264776203" class="timestamp"><time class="timestamp" datetime="2015-03-25T14:35:38Z" is="relative-time">Mar 25, 2015</time></a>
    </div>
  </div>






  <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-842f5c2">
      <span class="discussion-item-icon">
        <span class="octicon octicon-bookmark "></span>
      </span>

      <img alt="@yuroyoro" class="avatar" height="16" src="https://avatars1.githubusercontent.com/u/18634?v=3&amp;s=32" width="16" />
      <a href="/yuroyoro" class="author" truncate="true">yuroyoro</a>

      referenced
      this issue
      from a commit
        in yuroyoro/rails
      <a href="#ref-commit-842f5c2" class="timestamp">
        <time datetime="2015-04-17T02:20:59Z" is="relative-time">Apr 17, 2015</time>
      </a>
    </div>

    <table class="timeline-commits">


<tr class="commit js-details-container js-socket-channel js-updatable-content"
    data-channel="rails/rails:commit:842f5c2dad8ed021274c16f2dc231c15ddefba18"
    data-url="/rails/rails/commit/842f5c2dad8ed021274c16f2dc231c15ddefba18/show_partial?partial=commit%2Fcondensed"
  >

  <td class="commit-icon">
      <span class="octicon octicon-git-commit "></span>
  </td>

    <td class="commit-gravatar">
      <a href="/yuroyoro"><img alt="@yuroyoro" class="avatar avatar-small" height="16" src="https://avatars1.githubusercontent.com/u/18634?v=3&amp;s=32" width="16" /></a>
    </td>

    <td class="commit-author">
      <strong><a href="/yuroyoro" class="author" rel="contributor">yuroyoro</a></strong>
    </td>

  <td class="commit-message">
      <code><a href="/yuroyoro/rails/commit/842f5c2dad8ed021274c16f2dc231c15ddefba18" class="message" data-pjax="true" title="Read already loaded association records from association.target

For performance, Avoid instantiate CollectionProxy.
Fixes #12537">Read already loaded association records from association.target</a></code>

        <span class="hidden-text-expander inline">
          <a href="#" class="js-details-target">&hellip;</a>
        </span>
        <div class="commit-desc"><pre class="text-small">For performance, Avoid instantiate CollectionProxy.
Fixes <a href="https://github.com/rails/rails/issues/12537" class="issue-link js-issue-link" data-url="https://github.com/rails/rails/issues/12537" data-id="20977004" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#12537</a></pre></div>

  </td>

  <td class="commit-meta">


        <code><a href="/yuroyoro/rails/commit/842f5c2dad8ed021274c16f2dc231c15ddefba18" class="commit-id">842f5c2</a></code>
  </td>
</tr>

    </table>
  </div>







  <div class="discussion-item discussion-item-unlabeled">
    <div class="discussion-item-header" id="event-340896695">

      <span class="discussion-item-icon">
        <span class="octicon octicon-tag "></span>
      </span>
      <img alt="@matthewd" class="avatar" height="16" src="https://avatars2.githubusercontent.com/u/1034?v=3&amp;s=32" width="16" />
      <a href="/matthewd" class="author">matthewd</a>
      removed the <span class="label-color" style="background-color: #eb6420;"><a href="/rails/rails/labels/openacademy" style="color: #fff">openacademy</a></span> label <a href="https://github.com/rails/rails/issues/12537#event-340896695" class="timestamp"><time class="timestamp" datetime="2015-06-26T08:11:01Z" is="relative-time">Jun 26, 2015</time></a>
    </div>
  </div>








  <div class="discussion-item discussion-item-closed">
    <div class="discussion-item-header" id="event-496423106">

      <span class="discussion-item-icon">
        <span class="octicon octicon-circle-slash "></span>
      </span>
      <img alt="@tenderlove" class="avatar" height="16" src="https://avatars2.githubusercontent.com/u/3124?v=3&amp;s=32" width="16" />
      <a href="/tenderlove" class="author">tenderlove</a>
      closed this in <a href="/rails/rails/issues/19423">#19423</a>  <a href="https://github.com/rails/rails/issues/12537#event-496423106" class="timestamp"><time class="timestamp" datetime="2015-12-19T02:46:15Z" is="relative-time">Dec 19, 2015</time></a>
    </div>
  </div>

  <div class="closed-banner"></div>










<!-- Rendered timeline since 2015-12-18 18:47:56 -->
<div id="partial-timeline-marker"
      class="js-timeline-marker js-socket-channel js-updatable-content"
      data-channel="rails/rails:issue:20977004"
      data-url="/rails/rails/issues/12537/show_partial?partial=issues%2Ftimeline_marker&amp;since=1450493276"
      data-last-modified="Sat, 19 Dec 2015 02:47:56 GMT">

    <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/rails/rails/notifications/mark?ids=18381122" class="hidden js-timeline-marker-form" data-form-nonce="9a3dc4e7f2b4d6410c95623b7687fcb6ae8f092f" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="authenticity_token" type="hidden" value="TVM/N2fMvdgxREqCciyJG3aUtUqZvO0U3rx8B7DDTlkHAoU3lGQHVYcdTD5FYL/T2/3KTyjfbv5kLJzs9uTuGg==" /></div>
</form></div>


        </div>

          <div class="discussion-timeline-actions">
                <div class="signed-out-comment">
  <a href="/join" class="btn btn-primary" rel="nofollow">Sign up for free</a>
  <strong>to join this conversation on GitHub</strong>.
  Already have an account?
  <a href="/login?return_to=https%3A%2F%2Fgithub.com%2Frails%2Frails%2Fissues%2F12537" rel="nofollow">Sign in to comment</a>
</div>


          </div>
      </div>

    </div>
    <div class="clear"></div>
  </div>

</div>


  </div>
  <div class="modal-backdrop"></div>
</div>

    </div>
  </div>

    </div>

        <div class="container">
  <div class="site-footer" role="contentinfo">
    <ul class="site-footer-links right">
        <li><a href="https://status.github.com/" data-ga-click="Footer, go to status, text:status">Status</a></li>
      <li><a href="https://developer.github.com" data-ga-click="Footer, go to api, text:api">API</a></li>
      <li><a href="https://training.github.com" data-ga-click="Footer, go to training, text:training">Training</a></li>
      <li><a href="https://shop.github.com" data-ga-click="Footer, go to shop, text:shop">Shop</a></li>
        <li><a href="https://github.com/blog" data-ga-click="Footer, go to blog, text:blog">Blog</a></li>
        <li><a href="https://github.com/about" data-ga-click="Footer, go to about, text:about">About</a></li>
        <li><a href="https://github.com/pricing" data-ga-click="Footer, go to pricing, text:pricing">Pricing</a></li>

    </ul>

    <a href="https://github.com" aria-label="Homepage">
      <span class="mega-octicon octicon-mark-github " title="GitHub "></span>
</a>
    <ul class="site-footer-links">
      <li>&copy; 2015 <span title="0.27428s from github-fe140-cp1-prd.iad.github.net">GitHub</span>, Inc.</li>
        <li><a href="https://github.com/site/terms" data-ga-click="Footer, go to terms, text:terms">Terms</a></li>
        <li><a href="https://github.com/site/privacy" data-ga-click="Footer, go to privacy, text:privacy">Privacy</a></li>
        <li><a href="https://github.com/security" data-ga-click="Footer, go to security, text:security">Security</a></li>
        <li><a href="https://github.com/contact" data-ga-click="Footer, go to contact, text:contact">Contact</a></li>
        <li><a href="https://help.github.com" data-ga-click="Footer, go to help, text:help">Help</a></li>
    </ul>
  </div>
</div>







    <div id="ajax-error-message" class="flash flash-error">
      <span class="octicon octicon-alert"></span>
      <button type="button" class="flash-close js-flash-close js-ajax-error-dismiss" aria-label="Dismiss error">
        <span class="octicon octicon-x"></span>
      </button>
      Something went wrong with that request. Please try again.
    </div>


      <script crossorigin="anonymous" src="https://assets-cdn.github.com/assets/frameworks-ef8eb4a89ee9f3c8b7613307fe589a8f5705817f7cee27bec51ce5e963234abf.js"></script>
      <script async="async" crossorigin="anonymous" src="https://assets-cdn.github.com/assets/github-4b6b8e7d11ebb7bce85126d3b4130c80041f2ae6d5d6ef8901a8c0c3f7cb80d2.js"></script>



    <div class="js-stale-session-flash stale-session-flash flash flash-warn flash-banner hidden">
      <span class="octicon octicon-alert"></span>
      <span class="signed-in-tab-flash">You signed in with another tab or window. <a href="">Reload</a> to refresh your session.</span>
      <span class="signed-out-tab-flash">You signed out in another tab or window. <a href="">Reload</a> to refresh your session.</span>
    </div>
  </body>
</html>

